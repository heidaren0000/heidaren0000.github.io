---
layout: post
title: MongoDB Cheat Sheet
date: 2020-03-10 19:52:00 +0800
authorize: Daren
categories: MongoDB
nutshell: 地球上竟然存在非关系型数据库这种东西
---

## 1. 介绍

mongoDB 是一种神奇的, 非关系型数据库, 在 Node 后端可以用到. 

安装文档: https://docs.mongodb.com/manual/tutorial/install-mongodb-on-os-x/

## 2. Cheat Sheet

### 1. 显示所有数据库

```shell
> show dbs
acme    0.000GB
admin   0.000GB
config  0.000GB
local   0.000GB
```

### 2. 使用数据库

```shell
> use acme
switched to db acme
```

### 3. 查看 collection

```shell
> show collections
```

### 4. 删除数据库

```shell
> db.dropDatabase()
{ "dropped" : "acme", "ok" : 1 }
```

### 5. 创建数据库

直接使用 `use` 即可, 这时使用 `show dbs` 依然看不到这个数据库是因为这个数据库是空的, 没有 collection

```shell
> use acme
switched to db acme
> show databases
admin   0.000GB
config  0.000GB
local   0.000GB
```

### 6. 查看当前数据库

```shell
> db
acme
```

### 7. 创建 collection

collection 类似于 table, 但是 不限制 column 类型

```shell
> db.createCollection('post');
{ "ok" : 1 }
> show collections
post
```

如果你想要更好的规整自己的语句, 可以先打开一个文本编辑器, 写好之后复制粘贴

### 8. 插入数据

```
db.post.insert({
	title: 'Post One',
	body: 'Body of pose one',
	category: 'News',
	likes: 4,
	tags: ['news', 'events'],
	user: {
		name: 'daren',
		status: 'author'
	},
	date: Date()
 })
```

```shell
> db.post.insert({
... title: 'Post One',
... body: 'Body of pose one',
... category: 'News',
... likes: 4,
... tags: ['news', 'events'],
... user: {
... name: 'daren',
... status: 'author'
... },
... date: Date()
...  })
WriteResult({ "nInserted" : 1 })
```

这里显示的结果是成功插入一个对象, 如果你想要插入多个对象, 可以

```db.post.insert({
db.post.insertMany([
  {
    title: 'Post two',
    body: 'Body of pose tow',
    category: 'News',
    likes: 4,
    date: Date()
   },
 {
	title: 'Post three',
	body: 'Body of pose three',
	category: 'News',
	likes: 4,
	date: Date()
 },
 {
	title: 'Post four',
	body: 'Body of pose 4',
	category: 'News',
	likes: 4,
	date: Date()
 }
])
```

```
> db.post.insertMany([
...   {
...     title: 'Post two',
...     body: 'Body of pose tow',
...     category: 'News',
...     likes: 4,
...     date: Date()
...    },
...  {
... title: 'Post three',
... body: 'Body of pose three',
... category: 'News',
... likes: 4,
... date: Date()
...  },
...  {
... title: 'Post four',
... body: 'Body of pose 4',
... category: 'News',
... likes: 4,
... date: Date()
...  }
... ])
{
	"acknowledged" : true,
	"insertedIds" : [
		ObjectId("5e674f3752653c974632c373"),
		ObjectId("5e674f3752653c974632c374"),
		ObjectId("5e674f3752653c974632c375")
	]
}
```

后面三个对象和之前的结构并不一样, 但是依然可以插入, 这里是和关系型数据库的一个很大的不同. 并没有列 column 的概念

成功后会返回这几个对象的 ID, 类似于在关系数据库的主键

### 9. 查询数据

```shell
> db.post.find()
{ "_id" : ObjectId("5e674dc452653c974632c372"), "title" : "Post One", "body" : "Body of pose one", "category" : "News", "likes" : 4, "tags" : [ "news", "events" ], "user" : { "name" : "daren", "status" : "author" }, "date" : "Tue Mar 10 2020 16:20:20 GMT+0800 (CST)" }
{ "_id" : ObjectId("5e67501052653c974632c376"), "title" : "Post two", "body" : "Body of pose tow", "category" : "News", "likes" : 4, "date" : "Tue Mar 10 2020 16:30:08 GMT+0800 (CST)" }
{ "_id" : ObjectId("5e67501052653c974632c377"), "title" : "Post three", "body" : "Body of pose three", "category" : "News", "likes" : 4, "date" : "Tue Mar 10 2020 16:30:08 GMT+0800 (CST)" }
{ "_id" : ObjectId("5e67501052653c974632c378"), "title" : "Post four", "body" : "Body of pose 4", "category" : "News", "likes" : 4, "date" : "Tue Mar 10 2020 16:30:08 GMT+0800 (CST)" }
> 
```

特别乱, 这个方法可以显示的更整洁:

```shell
> db.post.find().pretty()
{
	"_id" : ObjectId("5e674dc452653c974632c372"),
	"title" : "Post One",
	"body" : "Body of pose one",
	"category" : "News",
	"likes" : 4,
	"tags" : [
		"news",
		"events"
	],
	"user" : {
		"name" : "daren",
		"status" : "author"
	},
	"date" : "Tue Mar 10 2020 16:20:20 GMT+0800 (CST)"
}
{
	"_id" : ObjectId("5e67501052653c974632c376"),
	"title" : "Post two",
	"body" : "Body of pose tow",
	"category" : "News",
	"likes" : 4,
	"date" : "Tue Mar 10 2020 16:30:08 GMT+0800 (CST)"
}
{
	"_id" : ObjectId("5e67501052653c974632c377"),
	"title" : "Post three",
	"body" : "Body of pose three",
	"category" : "News",
	"likes" : 4,
	"date" : "Tue Mar 10 2020 16:30:08 GMT+0800 (CST)"
}
{
	"_id" : ObjectId("5e67501052653c974632c378"),
	"title" : "Post four",
	"body" : "Body of pose 4",
	"category" : "News",
	"likes" : 4,
	"date" : "Tue Mar 10 2020 16:30:08 GMT+0800 (CST)"
}
> 
```

### 10. 匹配某个属性

```shell
> db.post.find({category: 'News'}).pretty()
{
	"_id" : ObjectId("5e674dc452653c974632c372"),
	"title" : "Post One",
	"body" : "Body of pose one",
	"category" : "News",
	"likes" : 4,
	"tags" : [
		"news",
		"events"
	],
	"user" : {
		"name" : "daren",
		"status" : "author"
	},
	"date" : "Tue Mar 10 2020 16:20:20 GMT+0800 (CST)"
}
{
	"_id" : ObjectId("5e67501052653c974632c376"),
	"title" : "Post two",
	"body" : "Body of pose tow",
	"category" : "News",
	"likes" : 4,
	"date" : "Tue Mar 10 2020 16:30:08 GMT+0800 (CST)"
}
{
	"_id" : ObjectId("5e67501052653c974632c377"),
	"title" : "Post three",
	"body" : "Body of pose three",
	"category" : "News",
	"likes" : 4,
	"date" : "Tue Mar 10 2020 16:30:08 GMT+0800 (CST)"
}
{
	"_id" : ObjectId("5e67501052653c974632c378"),
	"title" : "Post four",
	"body" : "Body of pose 4",
	"category" : "News",
	"likes" : 4,
	"date" : "Tue Mar 10 2020 16:30:08 GMT+0800 (CST)"
}
> 
```

显示所有 category 值为 News 的对象.并且进行排版

### 11. 结果排序

```shell
> db.posts.find().sort({ title: 1 }).pretty()
{
	"_id" : ObjectId("5e674f3752653c974632c375"),
	"title" : "Post four",
	"body" : "Body of pose 4",
	"category" : "News",
	"likes" : 4,
	"date" : "Tue Mar 10 2020 16:26:31 GMT+0800 (CST)"
}
{
	"_id" : ObjectId("5e674f3752653c974632c374"),
	"title" : "Post three",
	"body" : "Body of pose three",
	"category" : "News",
	"likes" : 4,
	"date" : "Tue Mar 10 2020 16:26:31 GMT+0800 (CST)"
}
{
	"_id" : ObjectId("5e674f3752653c974632c373"),
	"title" : "Post two",
	"body" : "Body of pose tow",
	"category" : "News",
	"likes" : 4,
	"date" : "Tue Mar 10 2020 16:26:31 GMT+0800 (CST)"
}
```

参数是 1 位升序, -1 位降序, 同时字符串的排序是按照字母表来的.

###  12. 结果统计

查看符合条件的结果:

```shell
> db.posts.find().sort({ title: -1 }).count()
3
```

### 13. 限制显示结果的数量

```shell
> db.posts.find().limit(2)
{ "_id" : ObjectId("5e674f3752653c974632c373"), "title" : "Post two", "body" : "Body of pose tow", "category" : "News", "likes" : 4, "date" : "Tue Mar 10 2020 16:26:31 GMT+0800 (CST)" }
{ "_id" : ObjectId("5e674f3752653c974632c374"), "title" : "Post three", "body" : "Body of pose three", "category" : "News", "likes" : 4, "date" : "Tue Mar 10 2020 16:26:31 GMT+0800 (CST)" }
```

只显示前两个. 

这些函数可以穿起来, 按照先后次序执行, 就跟 JS 一样

### 14. 使用函数操作结果集

```
db.post.find().forEach(
	function(doc) {
		print('Blog Post: ' + doc.title)
	}
)
```

```shell
> db.post.find().forEach(
... function(doc) {
... print('Blog Post: ' + doc.title)
... }
... )
Blog Post: Post One
Blog Post: Post two
Blog Post: Post three
Blog Post: Post four
> 

```

### 15. 返回符合条件的第一个结果

```shell
> db.post.findOne({likes: 4})
{
	"_id" : ObjectId("5e674dc452653c974632c372"),
	"title" : "Post One",
	"body" : "Body of pose one",
	"category" : "News",
	"likes" : 4,
	"tags" : [
		"news",
		"events"
	],
	"user" : {
		"name" : "daren",
		"status" : "author"
	},
	"date" : "Tue Mar 10 2020 16:20:20 GMT+0800 (CST)"
}

```

### 16. 更新某个对象

这种更新方式会覆盖整个对象

```
db.post.update({title: 'Post Two'},
	{
		title: 'Post Two',
		body: 'New Post Two Body',
		date: Date()
	},
	{
		upsert: true
	}
)
```

这个函数有三个参数: 第一个用来查找符合条件的对象, 第二个参数对象会覆盖找到的对象, 第三个可选参数 upsert 如果为真的话就会在没有找到符合条件的值值的情况下新建一个

```shell
> db.post.update({title: 'Post Two'},
... {
... title: 'Post Two',
... body: 'New Post Two Body',
... date: Date()
... },
... {
... upsert: true
... }
... )
WriteResult({
	"nMatched" : 0,
	"nUpserted" : 1,
	"nModified" : 0,
	"_id" : ObjectId("5e67609645cfd004557151fa")
})
> db.post.find({title: 'Post Two'}).pretty();
{
	"_id" : ObjectId("5e67609645cfd004557151fa"),
	"title" : "Post Two",
	"body" : "New Post Two Body",
	"date" : "Tue Mar 10 2020 17:40:38 GMT+0800 (CST)"
}
> 
```

可以看到已经被修改了, 而且是整个覆盖掉

### 17. 在不覆盖的情况下更新对象

如果要避免数据被覆盖掉, 你需要一个 `$set` 运算符

```
db.post.update({ title: 'Post Two'},
	{
		$set: {
			cat: 'tom'
		}
	})
```

```shell
> db.post.update({ title: 'Post Two'},
... {
... $set: {
... cat: 'tom'
... }
... })
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })
> db.post.find({title: 'Post Two'}).pretty();
{
	"_id" : ObjectId("5e67609645cfd004557151fa"),
	"title" : "Post Two",
	"body" : "New Post Two Body",
	"date" : "Tue Mar 10 2020 17:40:38 GMT+0800 (CST)",
	"cat" : "tom"
}
> 
```

只更新了 cat

### 18. 使对象的中数字在原来的基础上进行增加

这里使用的是 `$inc` 运算符

```
db.post.update({ title: 'Post One' },
	{
		$inc: { likes: 2 }
	}
)
```

```shell
> db.post.find({title: 'Post Two'}).pretty();
{
	"_id" : ObjectId("5e67609645cfd004557151fa"),
	"title" : "Post Two",
	"body" : "New Post Two Body",
	"date" : "Tue Mar 10 2020 17:40:38 GMT+0800 (CST)",
	"cat" : "tom"
}
> db.post.update({ title: 'Post One' },
... {
... $inc: { likes: 2 }
... }
... )
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })
> db.post.find({title: 'Post One'}).pretty();
{
	"_id" : ObjectId("5e674dc452653c974632c372"),
	"title" : "Post One",
	"body" : "Body of pose one",
	"category" : "News",
	"likes" : 6,
	"tags" : [
		"news",
		"events"
	],
	"user" : {
		"name" : "daren",
		"status" : "author"
	},
	"date" : "Tue Mar 10 2020 16:20:20 GMT+0800 (CST)"
}
```

### 19. 重命名某个对象

使用 `$rename` 运算符

```
db.post.update({ title: 'Post One' },
	{
		$rename: { likes: 'view' }
	}
)
```

```shell
> db.post.update({ title: 'Post One' },
... {
... $rename: { likes: 'view' }
... }
... )
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })
> db.post.find({title: 'Post One'}).pretty();
{
	"_id" : ObjectId("5e674dc452653c974632c372"),
	"title" : "Post One",
	"body" : "Body of pose one",
	"category" : "News",
	"tags" : [
		"news",
		"events"
	],
	"user" : {
		"name" : "daren",
		"status" : "author"
	},
	"date" : "Tue Mar 10 2020 16:20:20 GMT+0800 (CST)",
	"view" : 6
}
>
```

`likes`已经变成`view`了.

### 20. 删除某个对象

```shell
> db.post.find().count()
5
> db.post.remove({ title: 'Post four'})
WriteResult({ "nRemoved" : 1 })
> db.post.find().count()
4
```

### 21. 写注释

在关系型数据库中, 开发者往往会在单独的表中写注释, 然后用这些注释表格的外键来连接需要注释的表格的主键, 来说明数据库各个表之间的关系.

但是在 Monngo 中你可以直接把注释嵌入到当前的 collection 中.

```
db.post.update({ title: 'Post One' },
	{
		$set: {
			comments: [
				{
					user: 'Mary Williams',
					body: 'Comment One',
					date: Date()
				},
				{
					user: 'Harry White',
					body: 'Comment Two',
					date: Date()
				}
			]
		}
	})
```

```shell
> db.post.find({ title: 'Post One'}).pretty()
{
	"_id" : ObjectId("5e674dc452653c974632c372"),
	"title" : "Post One",
	"body" : "Body of pose one",
	"category" : "News",
	"tags" : [
		"news",
		"events"
	],
	"user" : {
		"name" : "daren",
		"status" : "author"
	},
	"date" : "Tue Mar 10 2020 16:20:20 GMT+0800 (CST)",
	"view" : 6,
	"comments" : [
		{
			"user" : "Mary Williams",
			"body" : "Comment One",
			"date" : "Tue Mar 10 2020 18:10:30 GMT+0800 (CST)"
		},
		{
			"user" : "Harry White",
			"body" : "Comment Two",
			"date" : "Tue Mar 10 2020 18:10:30 GMT+0800 (CST)"
		}
	]
}
>
```

用这种方式直接把 Commit 写在对象里.

### 22. 根据对象的值进行匹配

假设我们要获取所有 comments 属性中含有 `Mary Willams`的对象.

```
db.post.find({
	comments: {
	$elemMatch: {
      user: 'Mary Williams'
    }
	}
}).pretty();
```

```shell
> db.post.find({
... comments: {
... $elemMatch: {
...       user: 'Mary Williams'
...     }
... }
... }).pretty();
{
	"_id" : ObjectId("5e674dc452653c974632c372"),
	"title" : "Post One",
	"body" : "Body of pose one",
	"category" : "News",
	"tags" : [
		"news",
		"events"
	],
	"user" : {
		"name" : "daren",
		"status" : "author"
	},
	"date" : "Tue Mar 10 2020 16:20:20 GMT+0800 (CST)",
	"view" : 6,
	"comments" : [
		{
			"user" : "Mary Williams",
			"body" : "Comment One",
			"date" : "Tue Mar 10 2020 18:10:30 GMT+0800 (CST)"
		},
		{
			"user" : "Harry White",
			"body" : "Comment Two",
			"date" : "Tue Mar 10 2020 18:10:30 GMT+0800 (CST)"
		}
	]
}
> 
```

### 23. 建立索引 (这个地方我没有完全理解, 也没成功)

```shell
> db.post.createIndex({ title: 'text' })
# 下面是执行结果
{
	"numIndexesBefore" : 2, # 这两行我没看懂
	"numIndexesAfter" : 2,
	"note" : "all indexes already exist",
	"ok" : 1
}
> 
```

查找 title 是`Post O`开头的对象:

```
db.post.find({
	$text: {
		$search: "\"Post O\"" 
	}
})
```

### 24. greater than 运算符

这个运算符可以匹配比某个值大的对象.

```
 db.post.find( {view: {
 	$gt: 1}
 }).pretty()
```

```shell
>  db.post.find( {view: {
...  $gt: 1}
...  }).pretty()
{
	"_id" : ObjectId("5e674dc452653c974632c372"),
	"title" : "Post One",
	"body" : "Body of pose one",
	"category" : "News",
	"tags" : [
		"news",
		"events"
	],
	"user" : {
		"name" : "daren",
		"status" : "author"
	},
	"date" : "Tue Mar 10 2020 16:20:20 GMT+0800 (CST)",
	"view" : 6,
	"comments" : [
		{
			"user" : "Mary Williams",
			"body" : "Comment One",
			"date" : "Tue Mar 10 2020 18:10:30 GMT+0800 (CST)"
		},
		{
			"user" : "Harry White",
			"body" : "Comment Two",
			"date" : "Tue Mar 10 2020 18:10:30 GMT+0800 (CST)"
		}
	]
}
> 

```

除了这个, 你还可以用 gte (大雨等于), lt (小于), lte (小于等于)



## 3. 最后

这里只是最简单的操作, 其实什么都写在文档里. 另外 MongoDB 的图形化工具 compass 也很方便. 除了在本地搭建 MongoDB, 你还可以去他的官网找 Atlas 的 Cluster 也很方便, 直接在云上就能用(有空我也要玩玩这个).

然后一会我在发一个 Youtube 大神 Traversy 做的 cheat sheet, 看腻了中文来电英文也很方便.